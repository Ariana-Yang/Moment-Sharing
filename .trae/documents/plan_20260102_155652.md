# Moment-Sharing 项目实现计划

## 1. 项目初始化

* 创建 Vite + React 18 + TypeScript 项目

* 安装核心依赖：Dexie.js、browser-image-compression、Tailwind CSS、Lucide-React

* 配置 Vite 和 Tailwind CSS

## 2. 数据库设计（关系型结构）

* **数据模型**：

  ```typescript
  interface Photo {
    id: string;
    memoryId: string;
    blob: Blob;
    mimeType: string;
    createdAt: number;
  }

  interface Memory {
    id: string;
    date: string;
    note: string;
    photoIds: string[];
    createdAt: number;
    updatedAt: number;
  }
  ```

* **数据库表结构**：

  * `memories` 表：存储记忆的文本信息和图片ID列表

  * `photos` 表：单独存储图片Blob数据，通过memoryId关联

* **索引设计**：为memoryId字段创建索引，优化查询性能

## 3. 核心逻辑实现

* **图片压缩**：使用browser-image-compression将图片压缩至1MB以内

* **记忆CRUD操作**：

  * 创建：压缩图片 → 保存图片到photos表 → 保存记忆到memories表

  * 读取：获取记忆列表，按需加载图片

  * 更新：更新memories表信息；支持新增图片（压缩+保存到photos表）；支持移除已有图片（从photos表级联删除）。

  * 删除：删除memories记录 → 级联删除photos表中关联的所有图片

* **数据导出/导入**：

  * 导出：将Blob转换为Base64 → 组装JSON数据 → 下载为文件

  * 导入：读取JSON文件 → 将Base64转换为Blob → 批量写入数据库

* **懒加载实现**：使用IntersectionObserver按需加载图片Blob

## 4. UI组件开发

* **Timeline组件**：

  * 按时间倒序展示记忆卡片

  * 先加载记忆文本信息

  * 按需加载图片缩略图（IntersectionObserver）

  * 编辑和删除功能

* **AddButton组件**：

  * 浮动添加按钮

  * 支持多选图片

* **EditorModal组件**：

  * 日期选择器

  * 文本输入框

  * 图片预览

  * 保存/取消功能

* **ImageViewer组件**：

  * 全屏图片展示

  * 支持左右切换

  * 键盘快捷键支持

* **SettingsModal组件**：

  * 数据导出/导入功能

  * 数据统计信息

## 5. 性能优化

* 图片懒加载：IntersectionObserver实现

* 数据库查询优化：使用索引，按需加载数据

* 组件优化：React.memo，useCallback，useMemo

* 图片压缩：控制单张图片大小在1MB以内

## 6. 技术实现细节

* **数据序列化**：

  * 导出时：Blob → Base64 → JSON

  * 导入时：JSON → Base64 → Blob

* **级联删除**：

  * 删除记忆时，自动删除关联的所有图片

  * 防止孤儿数据占用空间

* **懒加载**：

  * 只有当记忆卡片进入视口时，才加载图片

  * 减少初始加载时间和内存占用

## 7. 开发流程

1. 创建项目结构和配置文件
2. 实现数据库层（db.ts）
3. 实现核心逻辑Hook（useMemories.ts）
4. 开发UI组件
5. 组装主页面
6. 测试和优化

该计划严格遵循了技术栈要求和特别注意事项，确保代码健壮性和性能优化。
